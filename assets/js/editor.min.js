$gp.editor=function(a){return{current:null,orginal_translations:null,init:function(e){var t;$gp.init(),$gp.editor.table=e,$gp.editor.install_hooks(),1===(t=$gp.editor.table.find("tr.preview")).length&&$gp.editor.show(t.eq(0))},original_id_from_row_id:function(e){return e.split("-")[0]},translation_id_from_row_id:function(e){return e.split("-")[1]},show:function(e){var t=e.closest("tr").attr("row"),r=a("#editor-"+t);r.length&&($gp.editor.current&&$gp.editor.hide(),r.preview=a("#preview-"+t),r.row_id=t,r.original_id=$gp.editor.original_id_from_row_id(t),r.translation_id=$gp.editor.translation_id_from_row_id(t),r.orginal_translations=a('textarea[name="translation['+r.original_id+'][]"]',r).map(function(){return this.value}).get(),($gp.editor.current=r).show(),r.preview.hide(),a("tr:first",$gp.editor.table).hide(),a("textarea:first",r).focus())},prev:function(){var e;$gp.editor.current&&((e=$gp.editor.current.prevAll("tr.editor")).length?$gp.editor.show(e.eq(0)):$gp.editor.hide())},next:function(){var e;$gp.editor.current&&((e=$gp.editor.current.nextAll("tr.editor")).length?$gp.editor.show(e.eq(0)):$gp.editor.hide())},hide:function(e){(e=e||$gp.editor.current)&&(e.hide(),e.preview.show(),a("tr:first",$gp.editor.table).show(),$gp.editor.current=null)},install_hooks:function(){a($gp.editor.table).on("click","a.edit",$gp.editor.hooks.show).on("dblclick","tr.preview td",$gp.editor.hooks.show).on("change","select.priority",$gp.editor.hooks.set_priority).on("click","a.close",$gp.editor.hooks.cancel).on("click","a.copy",$gp.editor.hooks.copy).on("click","a.discard-warning",$gp.editor.hooks.discard_warning).on("click","button.approve",$gp.editor.hooks.set_status_current).on("click","button.reject",$gp.editor.hooks.set_status_rejected).on("click","button.fuzzy",$gp.editor.hooks.set_status_fuzzy).on("click","button.ok",$gp.editor.hooks.ok).on("keydown","tr.editor textarea",$gp.editor.hooks.keydown),a("#translations").tooltip({items:".glossary-word",content:function(){var i=a("<ul>");return a.each(a(this).data("translations"),function(e,t){var r=a("<li>");t.locale_entry&&r.append(a("<span>",{text:t.locale_entry}).addClass("locale-entry bubble")),r.append(a("<span>",{text:t.pos}).addClass("pos")),r.append(a("<span>",{text:t.translation}).addClass("translation")),r.append(a("<span>",{text:t.comment}).addClass("comment")),i.append(r)}),i},hide:!1,show:!1}),a.valHooks.textarea={get:function(e){return e.value.replace(/\r?\n/g,"\r\n")}}},keydown:function(e){var t,r,i,o,n;if(27===e.keyCode||90===e.keyCode&&e.shiftKey&&e.ctrlKey)$gp.editor.hide();else if(33===e.keyCode||38===e.keyCode&&e.ctrlKey)$gp.editor.prev();else if(34===e.keyCode||40===e.keyCode&&e.ctrlKey)$gp.editor.next();else if(13===e.keyCode&&"feedback"===a(e.target).attr("name"))a(".editor:visible").find(".reject-submit").trigger("click");else if(13===e.keyCode&&e.shiftKey)t=a(e.target),0===e.altKey&&t.val().length&&((r=t.closest(".textareas").prev()).children()?t.val(r.find(".original").text()):t.val(r.text())),t.nextAll("textarea").length?t.nextAll("textarea").eq(0).focus():$gp.editor.save(t.parents("tr.editor").find("button.ok"));else if(13===e.keyCode&&e.ctrlKey||66===e.keyCode&&e.shiftKey&&e.ctrlKey)0<(n=a(".editor:visible").find(".copy")).length&&n.trigger("click");else if(107===e.keyCode&&e.ctrlKey||65===e.keyCode&&e.shiftKey&&e.ctrlKey)0<(i=a(".editor:visible").find(".approve")).length&&i.trigger("click");else if(109===e.keyCode&&e.ctrlKey||82===e.keyCode&&e.shiftKey&&e.ctrlKey)0<(o=a(".editor:visible").find(".reject")).length&&(o.hasClass("opened")?a(".editor:visible").find(".reject-submit").trigger("click"):o.trigger("click"));else if(192===e.keyCode&&e.ctrlKey||192===e.keyCode&&e.shiftKey&&e.ctrlKey)0<(o=a(".editor:visible").find(".fuzzy")).length&&o.trigger("click");else{if(!e.ctrlKey||!(49<=e.keyCode&&e.keyCode<=57||97<=e.keyCode&&e.keyCode<=105))return!0;var s;o=a(".editor:visible").find(".reject"),s=49<=e.keyCode&&e.keyCode<=57?e.keyCode-49:e.keyCode-97,0<o.length&&(o.hasClass("opened")||o.trigger("click"),a(".editor:visible").find("input[name='reject_reason[]']").eq(s).trigger("click"))}return!1},replace_current:function(e){var t;$gp.editor.current&&($gp.editor.current.after(e),(t=$gp.editor.current).attr("id",t.attr("id")+"-old"),t.preview.attr("id",t.preview.attr("id")+"-old"),$gp.editor.next(),t.preview.remove(),t.remove())},save:function(r){var e,t,i,o=[];$gp.editor.current&&(e=$gp.editor.current,r.prop("disabled",!0),$gp.notices.notice("Saving&hellip;"),o={original_id:e.original_id,_gp_route_nonce:r.data("nonce")},t="translation["+e.original_id+"][]",i=a('textarea[name="'+t+'"]',e).map(function(){return this.value}).get(),o[t]=i,a.ajax({type:"POST",url:$gp_editor_options.url,data:o,dataType:"json",success:function(e){var t;for(t in r.prop("disabled",!1),$gp.notices.success("Saved!"),e)$gp.editor.replace_current(e[t]);$gp.editor.current.hasClass("no-warnings")&&$gp.editor.next()},error:function(e,t){r.prop("disabled",!1),t=e.responseText?"Error: "+e.responseText:"Error saving the translation!",$gp.notices.error(t)}}))},set_priority:function(r){var e,t;$gp.editor.current&&(e=$gp.editor.current,r.prop("disabled",!0),$gp.notices.notice("Setting priority&hellip;"),t={priority:a("option:selected",r).val(),_gp_route_nonce:r.data("nonce")},a.ajax({type:"POST",url:$gp_editor_options.set_priority_url.replace("%original-id%",e.original_id),data:t,success:function(){var e;r.prop("disabled",!1),$gp.notices.success("Priority set!"),e="priority-"+a("option:selected",r).text(),$gp.editor.current.addClass(e),$gp.editor.current.preview.addClass(e)},error:function(e,t){r.prop("disabled",!1),t=e.responseText?"Error: "+e.responseText:"Error setting the priority!",$gp.notices.error(t)}}))},set_status:function(r,e){var t,i,o=!1;$gp.editor.current&&$gp.editor.current.translation_id&&(t=$gp.editor.current,a('[id*="translation_'+t.original_id+'_"]').each(function(){this.value!==this.defaultValue&&(o=!0)}),o?$gp.notices.error("Translation has changed! Please add the new translation before changing it's status."):(r.prop("disabled",!0),$gp.notices.notice("Setting status to &#8220;"+e+"&#8221;&hellip;"),i={translation_id:t.translation_id,status:e,_gp_route_nonce:r.data("nonce")},a.ajax({type:"POST",url:$gp_editor_options.set_status_url,data:i,success:function(e){r.prop("disabled",!1),$gp.notices.success("Status set!"),$gp.editor.replace_current(e),$gp.editor.next()},error:function(e,t){r.prop("disabled",!1),t=e.responseText?"Error: "+e.responseText:"Error setting the status!",$gp.notices.error(t)}})))},open_reject_reasons:function(r){if($gp.editor.current&&$gp.editor.current.translation_id){if(r.hasClass("opened"))return r.html(r.data("open")),r.closest("dl").next("dl").remove(),void r.removeClass("opened");r.addClass("opened"),r.data("open",r.html()),r.html(r.data("close")),r.closest("dl").after(a("#reject-reasons-template").html()),a(".editor:visible [name=feedback]").focus(),a(".editor:visible").find(".reject-submit").on("click",function(){$gp.notices.notice("Setting status to &#8220;"+status+"&#8221;&hellip;");var e=[];a(".editor:visible input[name='reject_reason[]']:checked").each(function(){e.push(this.getAttribute("value"))});var t={translation_id:$gp.editor.current.translation_id,status:"rejected",reasons:e,feedback:a(".editor:visible [name=feedback]").val(),_gp_route_nonce:r.data("nonce")};a.ajax({type:"POST",url:$gp_editor_options.reject_feedback_url,data:t,success:function(e){r.prop("disabled",!1),$gp.notices.success("Translation Rejected!"),$gp.editor.replace_current(e),$gp.editor.next()},error:function(e,t){r.prop("disabled",!1),t=e.responseText?"Error: "+e.responseText:"Error setting the status!",$gp.notices.error(t)}})})}},discard_warning:function(e){var t;$gp.editor.current&&($gp.notices.notice("Discarding&hellip;"),t={translation_id:$gp.editor.current.translation_id,key:e.data("key"),index:e.data("index"),_gp_route_nonce:e.data("nonce")},a.ajax({type:"POST",url:$gp_editor_options.discard_warning_url,data:t,success:function(e){$gp.notices.success("Saved!"),$gp.editor.replace_current(e)},error:function(e,t){t=e.responseText?"Error: "+e.responseText:"Error saving the translation!",$gp.notices.error(t)}}))},copy:function(e){var t=e.parents(".textareas").find("textarea").attr("id").split("_"),r=parseInt(t[t.length-1],10),i=e.parents(".textareas").prev().find(".original").eq(r);i.hasClass("original")||(i=e.parents(".strings").find(".original").eq(r)),i=(i=i.text()).replace(/<span class=.invisibles.*?<\/span>/g,""),e.parents(".textareas").find("textarea").val(i).focus()},hooks:{show:function(){return $gp.editor.show(a(this)),!1},hide:function(){return $gp.editor.hide(),!1},ok:function(){return $gp.editor.save(a(this)),!1},cancel:function(){var e=0;for(e=0;e<$gp.editor.current.orginal_translations.length;e++)a('textarea[id="translation_'+$gp.editor.current.original_id+"_"+e+'"]').val($gp.editor.current.orginal_translations[e]);return $gp.editor.hide(),!1},keydown:function(e){return $gp.editor.keydown(e)},copy:function(){return $gp.editor.copy(a(this)),!1},discard_warning:function(){return $gp.editor.discard_warning(a(this)),!1},set_status_current:function(){return $gp.editor.set_status(a(this),"current"),!1},set_status_rejected:function(){return $gp.editor.open_reject_reasons(a(this)),!1},set_status_fuzzy:function(){return $gp.editor.set_status(a(this),"fuzzy"),!1},set_priority:function(){return $gp.editor.set_priority(a(this)),!1}}}}(jQuery),jQuery(function(e){$gp.editor.init(e("#translations"))});
